<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.mapper.ArticleMapper">

    <insert id="createArticle" parameterType="com.example.model.Article">
        INSERT INTO articles (author_id, type, title)
        VALUES (#{authorID}, #{type}, #{title})
    </insert>

    <select id="listArticles" resultType="com.example.model.Article">
        SELECT *
        FROM articles
        WHERE author_id = #{authorID}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{amount}
    </select>

    <select id="countArticles" resultType="int">
        SELECT COUNT(*)
        FROM articles
        WHERE author_id = #{authorID}
    </select>

    <select id="getArticle" resultType="com.example.model.Article">
        SELECT *
        FROM articles
        WHERE id = #{articleID}
    </select>

    <update id="updateArticleBody" parameterType="com.example.model.Article">
        UPDATE articles
        SET body = #{body}
        WHERE id = #{articleID} AND author_id = #{userID}
    </update>

    <update id="updateArticleTitle" parameterType="com.example.model.Article">
        UPDATE articles
        SET title = #{title}
        WHERE id = #{articleID} AND author_id = #{userID}
    </update>

    <delete id="deleteArticle">
        DELETE FROM articles
        WHERE id = #{articleID} AND author_id = #{userID}
    </delete>

    <update id="setArticleVisibility">
        UPDATE articles
        SET is_private = #{isPrivate}
        WHERE id = #{articleID} AND author_id = #{userID}
    </update>

    <update id="toggleArticleLike">
        UPDATE articles
        SET likes = CASE WHEN EXISTS (SELECT * FROM article_likes WHERE article_id = #{articleID} AND user_id = #{userID})
                             THEN likes - 1 ELSE likes + 1 END
        WHERE id = #{articleID}
    </update>

    <select id="isLiked" resultType="boolean">
        SELECT EXISTS (SELECT * FROM article_likes WHERE article_id = #{articleID} AND user_id = #{userID})
    </select>

</mapper>
